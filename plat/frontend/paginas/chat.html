<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Chat</title>
  <link href="https://cdn.tailwindcss.com" rel="stylesheet">
</head>
<body class="bg-gradient-to-r from-indigo-900 to-purple-900 text-white min-h-screen p-4 font-sans">

  <div class="max-w-5xl mx-auto flex gap-6">
    <!-- Lista de usu치rios -->
    <aside class="w-1/4 bg-white bg-opacity-10 rounded-lg p-4">
      <h2 class="text-xl font-bold mb-4">Conversar com:</h2>
      <ul id="usuariosList" class="space-y-2"></ul>
    </aside>

    <!-- Chat -->
    <main class="flex-1 bg-white bg-opacity-10 rounded-lg p-4 flex flex-col">
      <h2 class="text-xl font-bold mb-2">Chat</h2>
      <div id="chatBox" class="flex-1 overflow-y-auto bg-black bg-opacity-20 rounded-lg p-4 mb-4 h-96">
        <p class="text-gray-300 text-sm italic">Selecione um usu치rio para iniciar uma conversa</p>
      </div>

      <form id="chatForm" class="flex gap-2">
        <input id="mensagemInput" type="text" placeholder="Digite sua mensagem" required
               class="flex-1 p-2 rounded text-black" />
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
          Enviar
        </button>
      </form>
    </main>
  </div>

  <script>
    const usuarioId = localStorage.getItem('id');
    const tipo = localStorage.getItem('tipo');
    const nome = localStorage.getItem('nome');
    let destinatarioId = null;

    const usuariosList = document.getElementById('usuariosList');
    const chatBox = document.getElementById('chatBox');
    const chatForm = document.getElementById('chatForm');
    const mensagemInput = document.getElementById('mensagemInput');

    async function carregarUsuarios() {
      try {
        const tipoOposto = tipo === 'terapeuta' ? 'paciente' : 'terapeuta';
        const res = await fetch(`http://localhost:3000/usuarios?tipo=${tipoOposto}`);
        const usuarios = await res.json();

        usuariosList.innerHTML = '';
        usuarios.forEach(u => {
          const li = document.createElement('li');
          li.textContent = u.nome;
          li.className = 'cursor-pointer hover:underline';
          li.onclick = () => selecionarUsuario(u._id, u.nome);
          usuariosList.appendChild(li);
        });
      } catch (err) {
        console.error('Erro ao carregar usu치rios:', err);
        usuariosList.innerHTML = '<p class="text-red-300">Erro ao buscar usu치rios</p>';
      }
    }

    async function selecionarUsuario(id, nome) {
      destinatarioId = id;
      chatBox.innerHTML = `<p class="text-gray-300 text-sm italic">Conversando com <strong>${nome}</strong></p>`;
      await carregarMensagens();
    }

    async function carregarMensagens() {
      if (!destinatarioId) return;

      try {
        const res = await fetch(`http://localhost:3000/chat/conversa/${usuarioId}/${destinatarioId}`);
        const mensagens = await res.json();

        chatBox.innerHTML = '';
        mensagens.forEach(msg => {
          const div = document.createElement('div');
          div.className = 'mb-2';
          const alinhamento = msg.remetenteId === usuarioId ? 'text-right' : 'text-left';
          div.innerHTML = `
            <p class="${alinhamento}">
              <span class="bg-white bg-opacity-20 px-3 py-1 rounded inline-block">
                ${msg.texto}
              </span>
            </p>
          `;
          chatBox.appendChild(div);
        });

        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (err) {
        console.error('Erro ao buscar mensagens:', err);
      }
    }

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const texto = mensagemInput.value.trim();
      if (!texto || !destinatarioId) return;

      try {
        await fetch('http://localhost:3000/chat/enviar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ remetenteId: usuarioId, destinatarioId, texto })
        });

        mensagemInput.value = '';
        await carregarMensagens();
      } catch (err) {
        console.error('Erro ao enviar mensagem:', err);
      }
    });

    carregarUsuarios();
  </script>
</body>
</html>
