<h2>Chat</h2>

<div>
  <label>Seu ID:</label>
  <input type="text" id="meuId" class="form-control" readonly />
</div>

<div class="mt-3">
  <label>Contatos disponíveis:</label>
  <ul id="listaContatos" class="list-group" style="max-height:200px; overflow-y:auto;"></ul>
</div>

<div id="chatArea" class="mt-4" style="display:none;">
  <h5>Conversa com: <span id="contatoNome"></span></h5>
  <div id="mensagens" style="height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; background:#fff;"></div>
  <div class="input-group mt-2">
    <input type="text" id="inputMsg" class="form-control" placeholder="Digite a mensagem" />
    <button id="btnEnviar" class="btn btn-success">Enviar</button>
  </div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
  const socket = io('http://localhost:3000');

  let meuId = localStorage.getItem('id');
  let meuTipo = localStorage.getItem('tipo'); // 'usuário' ou 'terapeuta'
  document.getElementById('meuId').value = meuId;

  let salaId = null;
  let contatoSelecionado = null;

  const listaContatos = document.getElementById('listaContatos');
  const chatArea = document.getElementById('chatArea');
  const contatoNomeSpan = document.getElementById('contatoNome');

  // Buscar contatos automaticamente
  async function carregarContatos() {
    let url;
    if(meuTipo === 'usuário') {
      // Usuário vê terapeutas
      url = 'http://localhost:3000/usuarios?tipo=terapeuta';
    } else {
      // Terapeuta vê pacientes
      url = 'http://localhost:3000/usuarios?tipo=usuário';
    }

    try {
      const res = await fetch(url);
      const contatos = await res.json();
      listaContatos.innerHTML = '';
      contatos.forEach(c => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.textContent = c.nome;
        li.dataset.id = c._id;
        li.style.cursor = 'pointer';

        li.addEventListener('click', () => abrirChat(c._id, c.nome));

        listaContatos.appendChild(li);
      });
    } catch(e) {
      listaContatos.innerHTML = '<li class="list-group-item text-danger">Erro ao carregar contatos</li>';
    }
  }

  function abrirChat(idContato, nomeContato) {
    contatoSelecionado = idContato;
    contatoNomeSpan.textContent = nomeContato;
    salaId = [meuId, contatoSelecionado].sort().join('_');
    socket.emit('joinRoom', salaId);
    chatArea.style.display = 'block';
    carregarHistorico(meuId, contatoSelecionado);
  }

  socket.on('receiveMessage', (data) => {
    if (data.roomId === salaId) {
      adicionarMensagem(data.remetenteId, data.texto);
    }
  });

  document.getElementById('btnEnviar').addEventListener('click', () => {
    const texto = document.getElementById('inputMsg').value.trim();
    if (!texto) return alert('Digite uma mensagem');
    if(!contatoSelecionado) return alert('Selecione um contato primeiro');

    const data = {
      roomId: salaId,
      remetenteId: meuId,
      texto: texto
    };

    socket.emit('sendMessage', data);

    // Salvar no banco via API
    fetch('http://localhost:3000/chat/enviar', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        remetenteId: meuId,
        destinatarioId: contatoSelecionado,
        texto: texto
      })
    });

    adicionarMensagem(meuId, texto);
    document.getElementById('inputMsg').value = '';
  });

  function adicionarMensagem(remetente, texto) {
    const div = document.getElementById('mensagens');
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('mb-2');
    msgDiv.style.fontWeight = remetente === meuId ? 'bold' : 'normal';
    msgDiv.textContent = (remetente === meuId ? 'Você: ' : 'Outro: ') + texto;
    div.appendChild(msgDiv);
    div.scrollTop = div.scrollHeight;
  }

  async function carregarHistorico(user1, user2) {
    const res = await fetch(`http://localhost:3000/chat/conversa/${user1}/${user2}`);
    const mensagens = await res.json();
    const div = document.getElementById('mensagens');
    div.innerHTML = '';
    mensagens.forEach(m => {
      adicionarMensagem(m.remetenteId, m.texto);
    });
  }

  carregarContatos();
</script>
