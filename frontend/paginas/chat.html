<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #1e3a8a, #6b21a8);
      background-size: 200% 200%;
      animation: gradientShift 15s ease infinite;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 text-white">

  <div class="w-full max-w-2xl bg-white bg-opacity-10 backdrop-blur-md rounded-xl p-6 shadow-lg">
    <h1 class="text-2xl font-bold mb-4 text-center">Chat</h1>

    <div id="chatBox" class="h-96 overflow-y-scroll border border-white rounded p-4 mb-4 bg-white bg-opacity-20 text-sm"></div>

    <div class="flex items-center space-x-2">
      <input id="mensagem" type="text" placeholder="Digite sua mensagem..." class="flex-1 px-4 py-2 rounded bg-white text-black" />
      <button onclick="enviarMensagem()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Enviar</button>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById('chatBox');
    const inputMensagem = document.getElementById('mensagem');

    const remetenteId = localStorage.getItem('id');
    const destinatarioId = localStorage.getItem('destinatarioId') || '666afbe11c4d1298a7c9e7b1'; // Substitua por ID real dinamicamente

    async function carregarMensagens() {
      try {
        const res = await axios.get(`http://localhost:3000/chat/conversa/${remetenteId}/${destinatarioId}`);
        chatBox.innerHTML = '';

        res.data.forEach(msg => {
          const msgDiv = document.createElement('div');
          msgDiv.className = msg.remetenteId === remetenteId ? 'text-right mb-2' : 'text-left mb-2';
          msgDiv.innerHTML = `<span class="inline-block px-3 py-2 rounded bg-white text-black">${msg.texto}</span>`;
          chatBox.appendChild(msgDiv);
        });

        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (e) {
        console.error('Erro ao carregar mensagens:', e);
        chatBox.innerHTML = '<p class="text-red-300">Erro ao carregar mensagens.</p>';
      }
    }

    async function enviarMensagem() {
      const texto = inputMensagem.value.trim();
      if (!texto) return;

      try {
        await axios.post('http://localhost:3000/chat/enviar', {
          remetenteId,
          destinatarioId,
          texto
        });
        inputMensagem.value = '';
        carregarMensagens();
      } catch (e) {
        console.error('Erro ao enviar:', e);
      }
    }

    carregarMensagens();
    setInterval(carregarMensagens, 5000); // Atualiza automaticamente a cada 5 segundos
  </script>
</body>
</html>
