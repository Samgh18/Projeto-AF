<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Agendar Sessão</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-4 bg-gradient-to-br from-indigo-900 to-purple-800 min-h-screen text-white font-sans">
  <h2 class="text-3xl font-bold mb-6">Agendar Nova Sessão</h2>

  <form id="form-agendamento" class="space-y-4 bg-white bg-opacity-10 p-6 rounded shadow max-w-xl">
    <div>
      <label for="terapeuta" class="block mb-1 font-medium">Selecione o Terapeuta</label>
      <select id="terapeuta" class="w-full p-2 rounded text-black" required></select>
    </div>

    <div>
      <label for="data" class="block mb-1 font-medium">Data</label>
      <input type="date" id="data" class="w-full p-2 rounded text-black" required />
    </div>

    <div>
      <label for="hora" class="block mb-1 font-medium">Horário</label>
      <select id="hora" class="w-full p-2 rounded text-black" required>
        <option value="">Selecione um horário</option>
        <option value="08:00">08:00</option>
        <option value="09:30">09:30</option>
        <option value="11:00">11:00</option>
        <option value="13:00">13:00</option>
        <option value="15:00">15:00</option>
        <option value="17:00">17:00</option>
      </select>
    </div>

    <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white font-bold">
      Agendar Sessão
    </button>

    <p id="mensagem" class="mt-4 text-sm font-medium"></p>
  </form>

  <script>
    const terapeutaSelect = document.getElementById('terapeuta');
    const mensagem = document.getElementById('mensagem');
    const idUsuario = localStorage.getItem('id');

    async function carregarTerapeutas() {
      try {
        const res = await fetch('http://localhost:3000/usuarios?tipo=terapeuta');
        const terapeutas = await res.json();

        terapeutaSelect.innerHTML = '<option value="">Selecione...</option>';
        terapeutas.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t._id;
          opt.textContent = t.nome;
          terapeutaSelect.appendChild(opt);
        });
      } catch (e) {
        mensagem.textContent = 'Erro ao carregar terapeutas.';
        mensagem.classList.add('text-red-400');
      }
    }

    document.getElementById('form-agendamento').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id_terapeuta = terapeutaSelect.value;
      const dataInput = document.getElementById('data').value;
      const hora = document.getElementById('hora').value;

      if (!id_terapeuta || !dataInput || !hora) {
        mensagem.textContent = 'Preencha todos os campos.';
        mensagem.classList.add('text-yellow-400');
        return;
      }

      const dataCompleta = `${dataInput}T${hora}:00`;

      try {
        const res = await fetch('http://localhost:3000/sessoes/cadastrar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id_usuario: idUsuario, id_terapeuta, data: dataCompleta })
        });

        if (res.ok) {
          mensagem.textContent = 'Sessão agendada com sucesso!';
          mensagem.className = 'text-green-400';
          document.getElementById('form-agendamento').reset();
        } else {
          const erro = await res.text();
          mensagem.textContent = 'Erro ao agendar: ' + erro;
          mensagem.className = 'text-red-400';
        }
      } catch (err) {
        mensagem.textContent = 'Erro ao conectar com o servidor.';
        mensagem.className = 'text-red-400';
      }
    });

    carregarTerapeutas();
  </script>
</body>
</html>
